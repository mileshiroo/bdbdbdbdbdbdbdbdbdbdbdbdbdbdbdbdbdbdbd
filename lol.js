function saveToFB(a,b,c,d,e){fbRef.push({url:a,x:b,y:c,imW:d,imH:e})}function buildEndPoint(a){return new Firebase(fbUrl+a)}function updateFragment(a,b,c){updateRef=buildEndPoint(a),updateRef.update({x:b,y:c})}function share(){var a=new window.FileReader;a.readAsDataURL(gifData),a.onloadend=function(){$.ajax({url:"https://api.imgur.com/3/upload.json",type:"POST",headers:{Authorization:"Client-ID 2a3f1f63c9b0857"},data:{image:a.result.replace("data:image/gif;base64,",""),type:"base64",name:"hehehe",title:"hehehe",description:"hehehe"},dataType:"json"}).success(function(a){var b="http://imgur.com/"+a.data.id+".gif",c=random(.2*displayWidth,.8*displayWidth),d=random(.2*displayHeight,.8*displayHeight);print("Uploaded to imgur successfully."),print(b),print(imW),saveToFB(b,c,d,imW/scaleDownFactor,imH/scaleDownFactor)}).error(function(){print("upload error")})}}function fragmentAdded(a){for(i=0;i<fragments.length;i++)if(fragments[i].key===a)return i;return-1}function setupFb(){fbRef.on("child_removed",function(a){key=a.key();var b=fragmentAdded(key);-1!=b&&(fragments[b].img.remove(),fragments.splice(b,1))}),fbRef.on("value",function(a){var b=a.val();for(var c in b){var d=b[c].x,e=b[c].y;if(b.hasOwnProperty(c)){var f=fragmentAdded(c);if(-1!=f)fragments[f].img.position(d-fragments[f].imW/2,e-fragments[f].imH/2),fragments[f].x=d,fragments[f].y=e;else{var g=b[c].url,h=b[c].imW,i=b[c].imH,j=createDiv("");captureOn&&j.hide(),j.position(d-h/2,e-i/2),j.style("width",h),j.style("height",i),j.style("background","url('"+g+"') no-repeat"),fragments.push({img:j,x:d,y:e,imW:h,imH:i,key:c,url:g,layer:layer}),layer++,init||(baby=!0,babyBorn=frameCount)}}}init&&(init=!1)},function(a){console.log("The read failed: "+a.code)})}function moveToTop(a){layer++,fragments[a].img.remove(),fragments[a].img=createDiv(""),fragments[a].img.position(fragments[a].x-fragments[a].imW/2,fragments[a].y-fragments[a].imH/2),fragments[a].img.style("width",fragments[a].imW),fragments[a].img.style("height",fragments[a].imH),fragments[a].img.style("background","url('"+fragments[a].url+"') no-repeat"),fragments[a].layer=layer}function hideFragments(){for(i=0;i<fragments.length;i++)fragments[i].img.hide()}function showFragments(){for(i=0;i<fragments.length;i++)fragments[i].img.show()}function startCam(){null==capture&&(capture=createCapture(VIDEO),capture.size(camW,camH),capture.hide()),captureOn=!0,cursor(CROSS),hideButtons(),setFragmentOpacity(1),hideFragments()}function changeFullscreen(){var a=fullscreen();fullscreen(!a)}function setup(){var a=(window.location!=window.parent.location?document.referrer:document.location).toString();print(a);var b="file:///Users/milespeyton/Desktop/bdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbd/index.html";if(a!=b&&"partsparts"!=a.slice("http://".length,17)){var c=a.indexOf(".partsparts"),d=a.slice("http://".length,c);fbUrl+=d.concat("/")}else fbUrl+=defaultRoom;fbRef=new Firebase(fbUrl),print(fbUrl),h=displayHeight,w=displayWidth,camW=w,camH=h,canvas=createCanvas(w,h),noStroke(),textFont("Arial"),setupFb(),captureButton=createButton("add a part"),captureButton.mousePressed(startCam),captureButton.position(20,20),captureButton.style("zIndex","1"),fullscreenButton=createButton("toggle fullscreen"),fullscreenButton.position(100,20),fullscreenButton.mousePressed(changeFullscreen),buttons.push(captureButton),buttons.push(fullscreenButton)}function hideButtons(){for(i=0;i<buttons.length;i++)buttons[i].hide()}function showButtons(){for(i=0;i<buttons.length;i++)buttons[i].show()}function drawSelectionShape(){push(),fill(255,80),stroke(20),strokeWeight(8),beginShape();for(var a=0;a<selection.length;a++)vertex(selection[a].x,selection[a].y);endShape(CLOSE),pop()}function generateMask(){var a=int(imW/scaleDownFactor),b=int(imH/scaleDownFactor);for(mask=createImage(a,b),mask.loadPixels(),whiteMask=createImage(a,b),whiteMask.loadPixels(),y=0;b>y;y++)for(x=0;a>x;x++){var c=scaleDownFactor*x+minPt.x,d=scaleDownFactor*y+minPt.y;ptInSelection(c,d)?(mask.set(x,y,color(255,0)),whiteMask.set(x,y,color(255,0))):(mask.set(x,y,color(0,255,0)),whiteMask.set(x,y,color(255)))}mask.updatePixels(),whiteMask.updatePixels()}function drawFragmentOutlines(){for(i=0;i<fragments.length;i++){var a=fragments[i].imW,b=fragments[i].imH;rect(fragments[i].x-a/2,fragments[i].y-b/2,fragments[i].imW,fragments[i].imH)}}function showMessage(a,b){textAlign(CENTER),textSize(20),"undefined"==typeof b?fill(0):fill(b),text(a,w/2,.4*h)}function camEnabled(){return null!=capture&&null!=capture.attribute("src")}function setFragmentOpacity(a,b){if("undefined"==typeof b)for(i=0;i<fragments.length;i++)fragments[i].img.style("opacity",a.toString());else for(i=0;i<fragments.length;i++)i!=b&&fragments[i].img.style("opacity",a.toString())}function draw(){if(captureOn)if(camEnabled())if(recording){clear(),image(capture,-int(minPt.x/scaleDownFactor),-int(minPt.y/scaleDownFactor),int(camW/scaleDownFactor),int(camH/scaleDownFactor)),image(mask,0,0),!rendering&&numFrames>framesAdded?(gif.addFrame(canvas.elt,{delay:50,copy:!0}),framesAdded++):rendering||(rendering=!0,gif.render()),clear();var a;a="undefnied"==typeof gif.finishedFrames?0:(gif.finishedFrames+1)/numFrames,image(capture,-int(minPt.x/scaleDownFactor),-int(minPt.y/scaleDownFactor),int(camW/scaleDownFactor),int(camH/scaleDownFactor)),fill(255,255),rect(0,height*(1-a),width,height),image(whiteMask,0,0)}else clear(),image(capture,0,0),drawSelectionShape(),showMessage("lasso a part to add",color(255));else clear(),showMessage("please enable your cam");else if(-1!=pickedUp&&updateFragment(fragments[pickedUp].key,mouseX,mouseY),baby)if(fragments.length>0&&frameCount-babyBorn>showBabyFor)baby=!1;else{var a=(frameCount-babyBorn)/showBabyFor;setFragmentOpacity(a,fragments.length-1)}}function mousePressed(){}function mouseDragged(){if(camEnabled()&&focused&&(0!=mouseX||0!=mouseY)&&captureOn&&camW>mouseX&&camH>mouseY&&((mouseX<minPt.x||0===selection.length)&&(minPt.x=mouseX),(mouseY<minPt.y||0===selection.length)&&(minPt.y=mouseY),(mouseX>maxPt.x||0===selection.length)&&(maxPt.x=mouseX),(mouseY>maxPt.y||0===selection.length)&&(maxPt.y=mouseY),selection.push({x:mouseX,y:mouseY})),-1==pickedUp&&!captureOn){for(topLayer=0,i=0;i<fragments.length;i++){var a=fragments[i].imW,b=fragments[i].imH;mouseX>fragments[i].x-a/2&&mouseX<fragments[i].x+a/2&&mouseY>fragments[i].y-b/2&&mouseY<fragments[i].y+b/2&&(-1==pickedUp||fragments[i].layer>topLayer)&&(pickedUp=i,topLayer=fragments[pickedUp].layer)}-1!=pickedUp&&moveToTop(pickedUp)}}function ptInSelection(a,b){var c=!1,d=selection.length-1;for(i=0;i<selection.length;i++)(selection[i].y<b&&selection[d].y>=b||selection[d].y<b&&selection[i].y>=b)&&selection[i].x+(b-selection[i].y)/(selection[d].y-selection[i].y)*(selection[d].x-selection[i].x)<a&&(c=!c),d=i;return c}function mouseReleased(){-1!=pickedUp&&(pickedUp=-1),selection.length>=3&&!recording&&(recording=!0,rendering=!1,imW=Math.abs(maxPt.x-minPt.x),imH=Math.abs(maxPt.y-minPt.y),generateMask(),gif=new GIF({workers:2,quality:10,repeat:0,transparent:65280,w:imW,h:imH}),resizeCanvas(int(imW/scaleDownFactor),int(imH/scaleDownFactor)),canvas.position(0,0),canvas.style("width",displayWidth),canvas.style("height",displayHeight),gif.on("finished",function(a){framesAdded=0,h=displayHeight,w=displayWidth,resizeCanvas(w,h),canvas.position(0,0),clear(),background(255),recording=!1,selection=[],showButtons(),showFragments(),captureOn=!1,cursor(ARROW),selectionImg=null,gifData=a,shared=!0,share()}))}function keyPressed(){if(88==keyCode&&-1!=pickedUp){var a=buildEndPoint(fragments[pickedUp].key);fragments[pickedUp].img.remove(),fragments.splice(pickedUp,1),a.remove(),pickedUp=-1}}var camW,camH,numFrames=30,framesAdded=0,gif=null,gifData=null,scaleDownFactor=2,selection=[],captureOn=!1,defaultRoom="secret/",init=!0,fragments=[],buttons=[],pickedUp=-1,mask=null,baby=!1,babyBorn=1,showBabyFor=40,whiteMask=null,recording=!1,rendering=!1,shared=!1,layer=0,minPt={x:0,y:0},maxPt={x:0,y:0},imH,imH,capture=null,canvas,captureButton,fullscreenButton,w,h,fbUrl="https://torid-fire-4253.firebaseIO.com/",fbRef;
